#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#              TrendRadar Zeabur å…¨è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½² TrendRadar åˆ° Zeabur..."
echo ""

# æ£€æŸ¥æ˜¯å¦æœ‰ git
if ! command -v git &> /dev/null; then
    echo "âŒ é”™è¯¯: æœªå®‰è£… git"
    echo "è¯·å…ˆå®‰è£… git: brew install git"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ gh CLI
if ! command -v gh &> /dev/null; then
    echo "âš ï¸  æœªå®‰è£… GitHub CLI"
    echo "æ­£åœ¨å®‰è£…..."
    brew install gh
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ­¥éª¤ 1: æ£€æŸ¥ GitHub ç™»å½•çŠ¶æ€
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ğŸ“‹ æ­¥éª¤ 1: æ£€æŸ¥ GitHub ç™»å½•çŠ¶æ€..."
if gh auth status &> /dev/null; then
    echo "âœ… å·²ç™»å½• GitHub"
else
    echo "ğŸ” éœ€è¦ç™»å½• GitHub..."
    gh auth login
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ­¥éª¤ 2: Fork TrendRadar ä»“åº“
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ“‹ æ­¥éª¤ 2: Fork TrendRadar ä»“åº“..."
REPO_ALREADY_FORKED=false

# æ£€æŸ¥æ˜¯å¦å·²ç» fork
if gh repo list --json name --limit 100 | grep -q "TrendRadar"; then
    echo "âœ… æ£€æµ‹åˆ°å·² fork çš„ TrendRadar ä»“åº“"
    REPO_ALREADY_FORKED=true
    REPO_NAME=$(gh repo list --json name --limit 100 | grep -B1 "TrendRadar" | head -1 | jq -r '.name')
else
    echo "æ­£åœ¨ fork ä»“åº“..."
    gh repo fork sansan0/TrendRadar --clone=false
    REPO_NAME="TrendRadar"
fi

# è·å– GitHub ç”¨æˆ·å
GITHUB_USER=$(gh api user --jq '.login')
FULL_REPO="${GITHUB_USER}/${REPO_NAME}"

echo "âœ… ä»“åº“: ${FULL_REPO}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ­¥éª¤ 3: å…‹éš†ä»“åº“åˆ°æœ¬åœ°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ“‹ æ­¥éª¤ 3: å…‹éš†ä»“åº“..."

WORK_DIR=$(mktemp -d)
echo "å·¥ä½œç›®å½•: ${WORK_DIR}"

if [ "$REPO_ALREADY_FORKED" = true ]; then
    git clone "git@github.com:${FULL_REPO}.git" "${WORK_DIR}"
else
    # ç­‰å¾… fork å®Œæˆ
    sleep 3
    git clone "git@github.com:${FULL_REPO}.git" "${WORK_DIR}"
fi

cd "${WORK_DIR}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ­¥éª¤ 4: é…ç½®å·²æ›´æ–°ï¼Œç›´æ¥æäº¤
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ“‹ æ­¥éª¤ 4: æäº¤é…ç½®æ›´æ”¹..."

git config user.email "trendradar@auto.deploy"
git config user.name "TrendRadar Auto Deploy"

git add config/frequency_words.txt config/ai_analysis_prompt.txt config/config.yaml

if git diff --cached --quiet; then
    echo "âš ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
else
    git commit -m "feat: è‡ªå®šä¹‰é…ç½®

- é‡åŒ–æŠ•èµ„å…³é”®è¯é…ç½®
- AIå‘å±•å’ŒæŠ€æœ¯è¿½è¸ª
- æ¨¡å‹ä¼˜æƒ æ´»åŠ¨ç›‘æ§
- AIåˆ†ææç¤ºè¯ä¼˜åŒ–"
    git push origin main
    echo "âœ… é…ç½®å·²æ¨é€åˆ° GitHub"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ­¥éª¤ 5: æ‰“å¼€ Zeabur éƒ¨ç½²é¡µé¢
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ“‹ æ­¥éª¤ 5: æ‰“å¼€ Zeabur éƒ¨ç½²..."
echo ""
echo "ğŸŒ å³å°†æ‰“å¼€ Zeabur éƒ¨ç½²é¡µé¢..."
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“– Zeabur éƒ¨ç½²æŒ‡å—"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1ï¸âƒ£  å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ Zeabur:"
echo "   - é¡µé¢ä¼šæç¤ºç™»å½•ï¼ˆä½¿ç”¨ GitHub è´¦å·ï¼‰"
echo "   - æˆæƒ Zeabur è®¿é—®ä½ çš„ä»“åº“"
echo ""
echo "2ï¸âƒ£  åˆ›å»ºé¡¹ç›®:"
echo "   - ç‚¹å‡» 'New Project'"
echo "   - åŒºåŸŸé€‰æ‹©: é¦™æ¸¯ æˆ– æ–°åŠ å¡"
echo "   - é¡¹ç›®åç§°: trendradar"
echo ""
echo "3ï¸âƒ£  éƒ¨ç½²æœåŠ¡:"
echo "   - ç‚¹å‡» 'Deploy Service'"
echo "   - é€‰æ‹© 'Git' â†’ 'GitHub'"
echo "   - é€‰æ‹© ${FULL_REPO}"
echo "   - Zeabur ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²"
echo ""
echo "4ï¸âƒ£  é…ç½®ç¯å¢ƒå˜é‡ (åœ¨ Zeabur æ§åˆ¶å°è®¾ç½®):"
echo "   TZ=Asia/Shanghai"
echo "   PUSHPLUS_TOKEN=ä½ çš„token"
echo "   æˆ–"
echo "   BARK_URL=https://api.day.app/ä½ çš„key"
echo ""
echo "5ï¸âƒ£  é…ç½®å®šæ—¶ä»»åŠ¡:"
echo "   æ¯2å°æ—¶: 0 */2 * * *"
echo "   æ¯å¤©9ç‚¹å’Œ18ç‚¹: 0 9,18 * * *"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ç”Ÿæˆ Zeabur éƒ¨ç½² URL
DEPLOY_URL="https://zeabur.com?via=github-cli"

# ç­‰å¾…ç”¨æˆ·ç¡®è®¤
echo ""
read -p "æŒ‰å›è½¦é”®æ‰“å¼€æµè§ˆå™¨..." </dev/tty

# æ‰“å¼€æµè§ˆå™¨
if [[ "$OSTYPE" == "darwin"* ]]; then
    open "${DEPLOY_URL}"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    xdg-open "${DEPLOY_URL}"
else
    echo "è¯·æ‰‹åŠ¨æ‰“å¼€æµè§ˆå™¨è®¿é—®: ${DEPLOY_URL}"
fi

echo ""
echo "âœ… è‡ªåŠ¨éƒ¨ç½²è„šæœ¬æ‰§è¡Œå®Œæˆï¼"
echo ""
echo "ğŸ“± æ¨é€æœåŠ¡é…ç½®æŒ‡å—:"
echo "   PushPlus: https://www.pushplus.plus"
echo "   Bark: App Store ä¸‹è½½ Bark åº”ç”¨"
echo ""
echo "å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ ZEABUR_DEPLOY.md æ–‡ä»¶"
